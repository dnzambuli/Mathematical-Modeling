---
title: "Group Task"
author: "Nzambuli Daniel", "Chesia Anika", "Brandon Gem", "Waimiri Romeo"
date: "2024-02-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Loading Libraries to Model SEIR-D with Children and Adults

```{r}
library(deSolve)
library(tidyverse)
library(DiagrammeR)
```

## States

```{r}
grViz("digraph flowchart {
      graph [layout = dot,
       rankdir = LR]
      node [fontname = Helvetica, shape = rectangle,]
      tab1 [label = '@@1']
      tab2 [label = '@@2']
      tab3 [label = '@@3'] 
      tab4 [label = '@@4']
      tab5 [label = '@@5']
      tab6 [label = '@@6']
      tab7 [label = '@@7']
      tab8 [label = '@@8']
      tab9 [label = '@@9']
      # edge definitions with the node IDs
      tab1 -> tab2 [label = 'beta child'];
      tab1 -> tab3 [label = 'beta adult'];
      tab2 -> tab4 [label = 'kapa child'];
      tab4 -> tab6 [label = 'mu child'];
      tab4 -> tab8 [label = 'gamma child'];
      tab3 -> tab5 [label = 'kapa adult'];
      tab5 -> tab7 [label = 'mu adult'];
      tab5 -> tab9 [label = 'gamma adult'];
      }

      [1]: 'Susceptible'
      [2]: 'Exposed Children'
      [3]: 'Exposed Adults'
      [4]: 'Infected Children'
      [5]: 'Infected Adult'
      [6]: 'Dead Children'
      [7]: 'Dead Adults'
      [8]: 'Recovered Children'
      [9]: 'Recovered Adults'
      ")
```

The SEIRD model extends the SEIR model by adding a compartment for individuals who have succumbed to the disease. The basic flow of individuals between compartments in the SEIRD model is as follows:

1.  S (Susceptible): Individuals who are not infected but can become exposed to the virus.
2.  E (Exposed): Individuals who have been exposed to the virus but are not yet infectious.
3.  I (Infectious): Individuals who are currently infected and can spread the disease to others.
4.  R (Recovered): Individuals who have recovered from the infection and are assumed to be immune.
5.  D (Dead): Individuals who have died as a result of the disease.

## The Differential Equations

$$
\frac{dS(t)}{dt} = \frac{-\beta S(t)I(t)}{N_{pop}}\\ \\
\frac{dE(t)}{dt} = \frac{+\beta S(t)I(t)}{N_{pop}} - \kappa E(t)\\ \\
\frac{dI(t)}{dt} = -\gamma I(t) + \kappa E(t)\\ \\
\frac{dR(t)}{dt} = +\gamma(1-\mu_h) min(\alpha I(t), I_h) + \gamma(1 - \mu_n)max(0, \alpha I(t), I_h) + \gamma(1-\alpha) I\\ \\
\frac{dD(t)}{dt} = +\gamma \mu_h min(\alpha I(t), I_h) + \gamma \mu_n max(0, \alpha I(t), I_h)\\ \\
\frac{dN_{pop}}{dt} = \frac{dS(t)}{dt} + \frac{dE(t)}{dt} + \frac{dI(t)}{dt} + \frac{dR(t)}{dt} + \frac{dD(t)}{dt} = 0
$$

## Initial Set-up

### Population Parameters

```{r}
population <- 10^6
infectious_no <- 3
N <- 1
epsilon = infectious_no/population
Ih <- 1 ### unlimited hospital capacity
mun <- 0.95 ### 0 < mun < 1
muh <- 1- mun
alpha <- 0.6
beta <- 1.2
kappa <- 1.4
gamma <-0.3

unit_time <- 70

# proportions
child_prop = 0.3
adult_prop = 0.7
```

> The model assumes equal
>
> -   death rate for children and adults
>
> -   hospitalization rates for children and adults
>
> -   transition to ICU for children and adults
>
> Children are proposed to be `30%` of the population

### Set-up for the Model

```{r}
# child
S_c = 0.3*  (1-epsilon)
E_c = 0
I_c = 0.3 * epsilon
R_c = 0
D_c = 0

# adult
S_a = 0.7*  (1-epsilon)
E_a = 0
I_a = 0.7 * epsilon
R_a = 0
D_a = 0

# time step
step_h = 0.001

```

### Parameters and State

```{r}
param = list(N = N, Ih = Ih, muh = muh, mun = mun, alpha = alpha, beta = beta, kappa = kappa, gamma = gamma, 
          S_c = S_c, E_c = E_c, I_c = I_c, R_c = R_c, D_c = D_c,
          S_a = S_a, E_a = E_a, I_a = I_a, R_a = R_a, D_a = D_a,
          step_h = step_h, unit_time = unit_time)
times <- seq(0, param$unit_time, by = param$step_h)
state <- c(S_c = param$S_c, E_c = param$E_c, I_c = param$I_c, R_c = param$R_c, D_c = param$D_c,
           S_a = param$S_a, E_a = param$E_a, I_a = param$I_a, R_a = param$R_a, D_a = param$D_a)
```

### SEIR-D model Function

```{r}
seir.d = function(t, states, param){
  with(as.list(c(states, param)),{
    # counts
    N_c = S_c + E_c + I_c + R_c + D_c
    N_a = S_a + E_a + I_a + R_a + D_a
    # child
    d.S_c = -beta * S_c * 1/N_c
    d.E_c = +beta * S_c * 1/N_c - kappa*E_c
    d.I_c = -gamma * I_c + kappa * E_c
    d.R_c = +gamma * (1 - muh) * min(alpha * I_c, Ih) + gamma * (1 - mun) * max(0,(alpha * I_c) - Ih) + gamma * (1 - alpha)* I_c
    d.D_c = +gamma * muh * min(alpha * I_c, Ih) + gamma * mun * max(0, (alpha * I_c) - Ih)
    d.N_c = d.S_c + d.E_c + d.I_c + d.R_c + d.D_c
    d.N_c = 0
    
    # adult
    d.S_a = -beta * S_a * 1/N_a
    d.E_a = +beta * S_a * 1/N_a - kappa*E_a
    d.I_a = -gamma * I_a + kappa * E_a
    d.R_a = +gamma * (1 - muh) * min(alpha * I_a, Ih) + gamma * (1 - mun) * max(0,(alpha * I_a) - Ih) + gamma * (1 - alpha)* I_a
    d.D_a = +gamma * muh * min(alpha * I_a, Ih) + gamma * mun * max(0, (alpha * I_a) - Ih)
    d.N_a = d.S_a + d.E_a + d.I_a + d.R_a + d.D_a
    d.N_a = 0
    list(c(d.S_a, d.E_a, d.I_a, d.R_a, d.D_a,
           d.S_c, d.E_a, d.I_a, d.R_a, d.D_a))
  })
}
```

## Generate the Output

```{r}
out_seir.d = as.data.frame(ode(y = state, times = times,
                               func = seir.d, parms = param))

```

### Output in long format

```{r}
library(tidyr)
output_long <- out_seir.d %>%  pivot_longer(cols = c(S_c, E_c, I_c, R_c, D_c, S_a, E_a, I_a, R_a, D_a),
                        names_to = "state",
                        values_to = "value") 

```

### Plot the data 

```{r}
ggplot(data = output_long,                                               
       aes(x = time, y = value, colour = state, group = state)) +  
  geom_line() +                                                          
  xlab("Time (days)")+                                                   
  ylab("Number of people") +                                
  labs(colour = "Compartment") 
```
